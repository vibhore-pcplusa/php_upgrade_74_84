#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

usage() {
  cat <<EOF
Usage: ./lab <command> [args]

Commands:
  up [path]      Start stack, mounting legacy app from [path] (default: ./sample-app)
  down           Stop stack
  use <74|84>    Switch active PHP version and restart web
  smoke:web      Curl the root URL via nginx
  smoke:cli      Run php -v and smoke.php in active PHP container
EOF
}

cmd=${1:-}
case "$cmd" in
  up)
    APP_PATH=${2:-"$ROOT_DIR/sample-app"}
    export LEGACY_APP_HOST_PATH="$APP_PATH"
    docker compose up -d --build
    ;;
  down)
    docker compose down
    ;;
  use)
    ver=${2:-}
    if [[ "$ver" != "74" && "$ver" != "84" ]]; then
      echo "Usage: ./lab use <74|84>" >&2
      exit 1
    fi
    sed -i.bak "s/^PHP_VERSION=.*/PHP_VERSION=$ver/" .env && rm .env.bak
    docker compose up -d --build web
    ;;
  smoke:web)
    curl -fsS http://localhost:8080/ | head -n 5
    ;;
  smoke:cli)
    source .env
    docker compose exec "php${PHP_VERSION}" php -v
    docker compose exec "php${PHP_VERSION}" php /var/www/html/smoke.php | head -n 10
    ;;
  *)
    usage
    exit 1
    ;;
esac
